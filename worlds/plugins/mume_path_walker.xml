<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- This Source Code Form is subject to the terms of the Mozilla Public -->
<!-- License, v. 2.0. If a copy of the MPL was not distributed with this -->
<!-- file, You can obtain one at http://mozilla.org/MPL/2.0/. -->

<!-- Saved on Saturday, February 18, 2012, 8:31 PM -->
<!-- MuClient version 4.81 -->

<!-- Plugin "mume_path_walker" generated by Plugin Wizard -->

<muclient>
<plugin
   name="mume_path_walker"
   author="Nick Stockton"
   id="052dd7f4b9c2157c133bdf75"
   language="Lua"
   purpose="Automaticly follow roads, Sunscreen for trolls, etc."
   date_written="2012-02-18 20:29:28"
   requires="4.70"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<aliases>
  <alias
   match="p *"
   enabled="y"
   group="mume_path_walker"
   send_to="12"
   sequence="100"
  >
<send>start_walking("%1")</send>
  </alias>
  <alias
   match="pp"
   enabled="y"
   group="mume_path_walker"
   send_to="12"
   sequence="100"
  >
<send>stop_walking()</send>
  </alias>
</aliases>


<script>
<![CDATA[
require("mystdlib")

tts = "925cdd0331023d9f0b8f05a7"
xml_parser = "74834d3734b2c8a3a9da4d18"
room_name = ""
walking = false
came_from = ""
reverse_directions = {
	["north"] = "south",
	["south"] = "north",
	["east"] = "west",
	["west"] = "east",
	["up"] = "down",
	["down"] = "up"
}

function OnPluginBroadcast (msg, id, name, text)
	if id == xml_parser and name == "mume_xml_parser" and msg == 1 then
		local return_code
		return_code, room_name = CallPlugin(xml_parser, "get", "name")
		if walking then
			local return_code, exits_line = CallPlugin(xml_parser, "get", "exits")
			walk_next(exits_line)
		end
	end
end

function walk_next(line)
	line = string.gsub(line, "^", "")
	local ways_forward = {}
	local roads = {}
	for direction, reversed in pairs(reverse_directions) do
		if string.match(line, string.format("=%s=", direction)) then
			if came_from ~= reversed then
				table.insert(ways_forward, direction)
			end -- if
			table.addToSet(roads, direction)
		end -- if
	end -- for
	if table.getn(ways_forward) == 1 then
		came_from = ways_forward[1]
		Send(came_from)
	elseif table.getn(ways_forward) == 0 then
		if room_name == "The East Road" or room_name == "Inside the Small Village of Frogmorton" or room_name == "Michel Delving" or room_name == "Road to Grey Havens" or room_name == "A Ford on the Way to Tharbad" then
			start_walking(came_from)
		elseif room_name == "Road to Tharbad" then
			if came_from == "south" then
				start_walking("east")
			elseif came_from == "west" then
				start_walking("west")
			end
		else
			stop_walking()
			CallPlugin(tts, "sayNote", "End of road reached.")
		end
	else
		if (room_name == "A Fork" or room_name == "Greenholm Junction") and (came_from == "east" or came_from == "west") then
			start_walking(came_from)
		elseif room_name == "Waymeet" and (came_from == "west" or came_from == "north") then
			if came_from == "west" then
				start_walking("south")
			elseif came_from == "north" then
				start_walking("east")
			end
		elseif room_name == "The Crossroad" and (came_from == "south" or came_from == "west") then
			if came_from == "south" then
				start_walking("east")
			elseif came_from == "west" then
				start_walking("north")
			end
		elseif room_name == "Road to Tharbad" then
			if table.setContains(roads, "north") and table.setContains(roads, "south") and table.setContains(roads, "west") and came_from ~= "south" and came_from ~= "west" then
				if came_from == "east" then
					start_walking("south")
				elseif came_from == "north" then
					start_walking("west")
				end
			elseif table.setContains(roads, "north") and table.setContains(roads, "east") and table.setContains(roads, "south") and came_from ~= "north" then
				if came_from == "south" then
					start_walking("east")
				elseif came_from == "west" then
					start_walking("north")
				end
			elseif table.setContains(roads, "east") and table.setContains(roads, "west") and table.setContains(roads, "south") and came_from ~= "north" then
				start_walking(came_from)
			end
		elseif room_name == "Greenway" then
			if table.setContains(roads, "north") and table.setContains(roads, "south") and table.setContains(roads, "west") and came_from ~= "east" then
				start_walking(came_from)
			elseif table.setContains(roads, "north") and table.setContains(roads, "east") and table.setContains(roads, "west") then
				if came_from == "west" then
					start_walking("north")
				elseif came_from == "east" or came_from == "south" then
					start_walking("east")
				end
			end
		elseif room_name == "The East Road" then
			if table.setContains(roads, "east") and table.setContains(roads, "west") and table.setContains(roads, "south") and came_from ~= "north" then
				start_walking(came_from)
			elseif table.setContains(roads, "east") and table.setContains(roads, "south") and table.setContains(roads, "north") and came_from ~= "south" then
				if came_from == "north" then
					start_walking("east")
				elseif came_from == "west" then
					start_walking("south")
				end
			elseif table.setContains(roads, "west") and table.setContains(roads, "north") and table.setContains(roads, "south") and came_from ~= "north" then
				if came_from == "east" then
					start_walking("north")
				elseif came_from == "south" then
					start_walking("west")
				end
			end
		else
			stop_walking()
			CallPlugin(tts, "sayNote", "Junction reached.")
		end
	end
end

function start_walking(line)
	local direction = nil
	for dir, reversed in pairs(reverse_directions) do
		if line ~= "" and string.sub(dir, 1, string.len(line)) == line then
			direction = dir
			break
		end
	end
	if direction then
		walking = true
		came_from = direction
		Send(came_from)
	else 
		CallPlugin(tts, "sayNote", "Invalid starting direction")
	end
end

function stop_walking()
	walking = false
	CallPlugin(tts, "sayNote", "Path Walker Disabled.")
end

]]>
</script>


</muclient>
